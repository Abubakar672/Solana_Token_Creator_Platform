{"version":3,"sources":["webpack://MetadataHelpers/webpack/bootstrap","webpack://MetadataHelpers/external \"@toruslabs/eccrypto\"","webpack://MetadataHelpers/external \"@toruslabs/http-helpers\"","webpack://MetadataHelpers/external \"@babel/runtime/helpers/defineProperty\"","webpack://MetadataHelpers/external \"json-stable-stringify\"","webpack://MetadataHelpers/external \"elliptic\"","webpack://MetadataHelpers/external \"keccak\"","webpack://MetadataHelpers/./src/utils.ts","webpack://MetadataHelpers/./src/MetadataStorageLayer.ts","webpack://MetadataHelpers/./src/webAuthnShareResolver.ts","webpack://MetadataHelpers/./src/index.ts"],"names":["keccak256","a","createKeccakHash","update","digest","ec","EC","MetadataStorageLayer","constructor","metadataHost","serverTimeOffset","setAPIKey","apiKey","setEmbedHost","embedHost","generateMetadataParams","message","privateKeyHex","key","keyFromPrivate","setData","data","timestamp","Math","floor","Date","now","toString","sig","sign","stringify","pub_key_X","getPublic","getX","pub_key_Y","getY","set_data","signature","Buffer","from","r","s","recoveryParam","padStart","slice","generatePubKeyParams","setMetadata","namespace","options","params","metadataResponse","post","useAPIKey","getMetadata","pubKey","WEBAUTHN_TORUS_SHARE","WEBAUTHN_DEVICE_SHARE","encParamsHexToBuf","encParamsHex","iv","ephemPublicKey","ciphertext","mac","encParamsBufToHex","encParams","encryptData","privKeyHex","d","serializedDec","JSON","serializedBuf","encrypt","sData","decryptData","parse","keyPair","decrypt","getPrivate","getAndDecryptData","m","serializedData","encryptAndSetData","metadataParams","setTorusShare","webAuthnPubKey","webAuthnRefHex","subspace","subspaceData","refKeyPair","privKey","keyFromPublic","x","y","serializedSubspaceData","serializedSubspaceDataBuf","encSubspaceData","encSubspaceDataHex","setDeviceShare","getTorusShare","webAuthnKeyHex","getDeviceShare"],"mappings":"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","file":"metadataHelpers.cjs.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 6);\n","module.exports = require(\"@toruslabs/eccrypto\");","module.exports = require(\"@toruslabs/http-helpers\");","module.exports = require(\"@babel/runtime/helpers/defineProperty\");","module.exports = require(\"json-stable-stringify\");","module.exports = require(\"elliptic\");","module.exports = require(\"keccak\");","import { ec as EC } from \"elliptic\";\nimport createKeccakHash from \"keccak\";\n\nexport function keccak256(a: string | Buffer): Buffer {\n  return createKeccakHash(\"keccak256\").update(a).digest();\n}\n\nexport const ec = new EC(\"secp256k1\");\n","import { post, setAPIKey, setEmbedHost } from \"@toruslabs/http-helpers\";\nimport stringify from \"json-stable-stringify\";\n\nimport { ec, keccak256 } from \"./utils\";\n\nexport type PubKeyParams = {\n  pub_key_X: string;\n  pub_key_Y: string;\n};\n\nexport type MetadataParams = PubKeyParams & {\n  set_data: {\n    data: string;\n    timestamp: string;\n  };\n  signature: string;\n};\n\nclass MetadataStorageLayer {\n  public metadataHost: string;\n\n  public serverTimeOffset: number; // ms\n\n  constructor(metadataHost = \"https://metadata.tor.us\", serverTimeOffset = 0) {\n    this.metadataHost = metadataHost;\n    this.serverTimeOffset = serverTimeOffset;\n  }\n\n  static setAPIKey(apiKey: string): void {\n    setAPIKey(apiKey);\n  }\n\n  static setEmbedHost(embedHost: string): void {\n    setEmbedHost(embedHost);\n  }\n\n  generateMetadataParams(message: string, privateKeyHex: string): MetadataParams {\n    const key = ec.keyFromPrivate(privateKeyHex, \"hex\");\n    const setData = {\n      data: message,\n      timestamp: Math.floor(this.serverTimeOffset + Date.now() / 1000).toString(16),\n    };\n    const sig = key.sign(keccak256(stringify(setData)));\n    return {\n      pub_key_X: key.getPublic().getX().toString(\"hex\"),\n      pub_key_Y: key.getPublic().getY().toString(\"hex\"),\n      set_data: setData,\n      signature: Buffer.from(\n        sig.r.toString(16, 64) + sig.s.toString(16, 64) + sig.recoveryParam?.toString(16).padStart(2, \"0\").slice(-2) ?? \"00\",\n        \"hex\"\n      ).toString(\"base64\"),\n    };\n  }\n\n  generatePubKeyParams(privateKeyHex: string): PubKeyParams {\n    const key = ec.keyFromPrivate(privateKeyHex, \"hex\");\n    return {\n      pub_key_X: key.getPublic().getX().toString(\"hex\"),\n      pub_key_Y: key.getPublic().getY().toString(\"hex\"),\n    };\n  }\n\n  async setMetadata(data: MetadataParams, namespace: string | null, options?: RequestInit): Promise<string> {\n    const params = namespace !== null ? { ...data, namespace } : data;\n    const metadataResponse = await post<{ message: string }>(`${this.metadataHost}/set`, params, options, { useAPIKey: true });\n    return metadataResponse.message;\n  }\n\n  async getMetadata(pubKey: PubKeyParams, namespace: string | null, options?: RequestInit): Promise<string> {\n    const params = namespace !== null ? { ...pubKey, namespace } : pubKey;\n    const metadataResponse = await post<{ message: string }>(`${this.metadataHost}/get`, params, options, { useAPIKey: true });\n    return metadataResponse.message;\n  }\n}\n\nexport default MetadataStorageLayer;\n","import { decrypt, Ecies, encrypt, getPublic } from \"@toruslabs/eccrypto\";\n\nimport MetadataStorageLayer, { PubKeyParams } from \"./MetadataStorageLayer\";\nimport { ec } from \"./utils\";\n\nconst WEBAUTHN_TORUS_SHARE = \"webauthn_torus_share\";\nconst WEBAUTHN_DEVICE_SHARE = \"webauthn_device_share\";\n\nexport type EciesHex = {\n  iv: string;\n  ephemPublicKey: string;\n  ciphertext: string;\n  mac: string;\n};\n\nexport function encParamsHexToBuf(encParamsHex: EciesHex): Ecies {\n  return {\n    iv: Buffer.from(encParamsHex.iv, \"hex\"),\n    ephemPublicKey: Buffer.from(encParamsHex.ephemPublicKey, \"hex\"),\n    ciphertext: Buffer.from(encParamsHex.ciphertext, \"hex\"),\n    mac: Buffer.from(encParamsHex.mac, \"hex\"),\n  };\n}\n\nexport function encParamsBufToHex(encParams: Ecies): EciesHex {\n  return {\n    iv: Buffer.from(encParams.iv).toString(\"hex\"),\n    ephemPublicKey: Buffer.from(encParams.ephemPublicKey).toString(\"hex\"),\n    ciphertext: Buffer.from(encParams.ciphertext).toString(\"hex\"),\n    mac: Buffer.from(encParams.mac).toString(\"hex\"),\n  };\n}\n\nexport async function encryptData(privKeyHex: string, d: unknown): Promise<string> {\n  const serializedDec = JSON.stringify(d);\n  const serializedBuf = Buffer.from(serializedDec, \"utf-8\");\n  const encParams = await encrypt(getPublic(Buffer.from(privKeyHex, \"hex\")), serializedBuf);\n  const encParamsHex = encParamsBufToHex(encParams);\n  const sData = JSON.stringify(encParamsHex);\n  return sData;\n}\n\nexport async function decryptData<T>(privKeyHex: string, d: string): Promise<T> {\n  const encParamsHex: EciesHex = JSON.parse(d);\n  const encParams = encParamsHexToBuf(encParamsHex);\n  const keyPair = ec.keyFromPrivate(privKeyHex);\n  const serializedBuf = await decrypt(Buffer.from(keyPair.getPrivate().toString(\"hex\", 64), \"hex\"), encParams);\n  const serializedDec = serializedBuf.toString(\"utf-8\");\n  const data: T = JSON.parse(serializedDec);\n  return data;\n}\n\nexport async function getAndDecryptData<T>(m: MetadataStorageLayer, privKeyHex: string, namespace: string): Promise<Record<string, T> | null> {\n  const keyPair = ec.keyFromPrivate(privKeyHex);\n  const pubKey = keyPair.getPublic();\n  const serializedData = await m.getMetadata({ pub_key_X: pubKey.getX().toString(16), pub_key_Y: pubKey.getY().toString(16) }, namespace);\n  if (!serializedData) {\n    return null;\n  }\n  const data = await decryptData<T>(privKeyHex, serializedData);\n  return data as Record<string, T>;\n}\n\nexport async function encryptAndSetData(m: MetadataStorageLayer, privKeyHex: string, d: Record<string, unknown>, namespace: string): Promise<void> {\n  const sData = await encryptData(privKeyHex, d);\n  const metadataParams = m.generateMetadataParams(sData, privKeyHex);\n  await m.setMetadata(metadataParams, namespace);\n}\n\nexport async function setTorusShare(\n  m: MetadataStorageLayer,\n  webAuthnPubKey: PubKeyParams,\n  webAuthnRefHex: string,\n  subspace: string,\n  subspaceData: unknown\n): Promise<void> {\n  const refKeyPair = ec.keyFromPrivate(webAuthnRefHex);\n  const privKey = refKeyPair.getPrivate();\n  const pubKey = ec.keyFromPublic({\n    x: webAuthnPubKey.pub_key_X,\n    y: webAuthnPubKey.pub_key_Y,\n  });\n  const data = await getAndDecryptData(m, webAuthnRefHex, WEBAUTHN_TORUS_SHARE);\n  let d: Record<string, unknown> = {};\n  if (data) d = data;\n  const serializedSubspaceData = JSON.stringify(subspaceData);\n  const serializedSubspaceDataBuf = Buffer.from(serializedSubspaceData, \"utf-8\");\n  const encSubspaceData = await encrypt(Buffer.from(pubKey.getPublic(\"hex\"), \"hex\"), serializedSubspaceDataBuf);\n  const encSubspaceDataHex = encParamsBufToHex(encSubspaceData);\n  d[subspace] = encSubspaceDataHex;\n  await encryptAndSetData(m, privKey.toString(\"hex\", 64), d, WEBAUTHN_TORUS_SHARE);\n}\n\nexport async function setDeviceShare(m: MetadataStorageLayer, webAuthnRefHex: string, subspace: string, subspaceData: unknown): Promise<void> {\n  const keyPair = ec.keyFromPrivate(webAuthnRefHex);\n  const privKey = keyPair.getPrivate();\n  const data = await getAndDecryptData(m, webAuthnRefHex, WEBAUTHN_DEVICE_SHARE);\n  let d: Record<string, unknown> = {};\n  if (data) d = data;\n  d[subspace] = subspaceData;\n  await encryptAndSetData(m, privKey.toString(\"hex\", 64), d, WEBAUTHN_DEVICE_SHARE);\n}\n\nexport async function getTorusShare<T>(m: MetadataStorageLayer, webAuthnKeyHex: string, webAuthnRefHex: string, subspace: string): Promise<T | null> {\n  const data = await getAndDecryptData<EciesHex>(m, webAuthnRefHex, WEBAUTHN_TORUS_SHARE);\n  if (!data) return null;\n  const encParamsHex = data[subspace];\n  if (!encParamsHex) return null;\n  const encParams = encParamsHexToBuf(encParamsHex);\n  const keyPair = ec.keyFromPrivate(webAuthnKeyHex);\n  const privKey = keyPair.getPrivate();\n  const serializedSubspaceDataBuf = await decrypt(Buffer.from(privKey.toString(\"hex\", 64), \"hex\"), encParams);\n  const serializedSubspaceData = serializedSubspaceDataBuf.toString(\"utf-8\");\n  const subspaceData = JSON.parse(serializedSubspaceData);\n  return subspaceData;\n}\n\nexport async function getDeviceShare<T>(m: MetadataStorageLayer, webAuthnRefHex: string, subspace: string): Promise<T | null> {\n  const data = await getAndDecryptData<T>(m, webAuthnRefHex, WEBAUTHN_DEVICE_SHARE);\n  if (data) return data[subspace];\n  return null;\n}\n","export * from \"./MetadataStorageLayer\";\nexport { default } from \"./MetadataStorageLayer\";\nexport * from \"./utils\";\nexport * from \"./webAuthnShareResolver\";\n"],"sourceRoot":""}