{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["import EventEmitter from 'eventemitter3';\nimport { PublicKey } from '@solana/web3.js';\nimport bs58 from 'bs58';\n\nexport default class Wallet extends EventEmitter {\n  constructor(provider, network) {\n    super();\n    if (isInjectedProvider(provider)) {\n      this._injectedProvider = provider;\n    } else if (isString(provider)) {\n      this._providerUrl = new URL(provider);\n      this._providerUrl.hash = new URLSearchParams({\n        origin: window.location.origin,\n        network,\n      }).toString();\n    } else {\n      throw new Error(\n        'provider parameter must be an injected provider or a URL string.',\n      );\n    }\n    this._network = network;\n    this._publicKey = null;\n    this._autoApprove = false;\n    this._popup = null;\n    this._handlerAdded = false;\n    this._nextRequestId = 1;\n    this._responsePromises = new Map();\n  }\n\n  _handleMessage = (e) => {\n    if (\n      (this._injectedProvider && e.source === window) ||\n      (e.origin === this._providerUrl.origin && e.source === this._popup)\n    ) {\n      if (e.data.method === 'connected') {\n        const newPublicKey = new PublicKey(e.data.params.publicKey);\n        if (!this._publicKey || !this._publicKey.equals(newPublicKey)) {\n          if (this._publicKey && !this._publicKey.equals(newPublicKey)) {\n            this._handleDisconnect();\n          }\n          this._publicKey = newPublicKey;\n          this._autoApprove = !!e.data.params.autoApprove;\n          this.emit('connect', this._publicKey);\n        }\n      } else if (e.data.method === 'disconnected') {\n        this._handleDisconnect();\n      } else if (e.data.result || e.data.error) {\n        if (this._responsePromises.has(e.data.id)) {\n          const [resolve, reject] = this._responsePromises.get(e.data.id);\n          if (e.data.result) {\n            resolve(e.data.result);\n          } else {\n            reject(new Error(e.data.error));\n          }\n        }\n      }\n    }\n  };\n\n  _handleConnect = () => {\n    if (!this._handlerAdded) {\n      this._handlerAdded = true;\n      window.addEventListener('message', this._handleMessage);\n      window.addEventListener('beforeunload', this.disconnect);\n    }\n    if (this._injectedProvider) {\n      return new Promise((resolve) => {\n        this._sendRequest('connect', {});\n        resolve();\n      });\n    } else {\n      window.name = 'parent';\n      this._popup = window.open(\n        this._providerUrl.toString(),\n        '_blank',\n        'location,resizable,width=460,height=675',\n      );\n      return new Promise((resolve) => {\n        this.once('connect', resolve);\n      });\n    }\n  };\n\n  _handleDisconnect = () => {\n    if (this._handlerAdded) {\n      this._handlerAdded = false;\n      window.removeEventListener('message', this._handleMessage);\n      window.removeEventListener('beforeunload', this.disconnect);\n    }\n    if (this._publicKey) {\n      this._publicKey = null;\n      this.emit('disconnect');\n    }\n    this._responsePromises.forEach(([resolve, reject], id) => {\n      this._responsePromises.delete(id);\n      reject('Wallet disconnected');\n    });\n  };\n\n  _sendRequest = async (method, params) => {\n    if (method !== 'connect' && !this.connected) {\n      throw new Error('Wallet not connected');\n    }\n    const requestId = this._nextRequestId;\n    ++this._nextRequestId;\n    return new Promise((resolve, reject) => {\n      this._responsePromises.set(requestId, [resolve, reject]);\n      if (this._injectedProvider) {\n        this._injectedProvider.postMessage({\n          jsonrpc: '2.0',\n          id: requestId,\n          method,\n          params: {\n            network: this._network,\n            ...params,\n          },\n        });\n      } else {\n        this._popup.postMessage(\n          {\n            jsonrpc: '2.0',\n            id: requestId,\n            method,\n            params,\n          },\n          this._providerUrl.origin,\n        );\n\n        if (!this.autoApprove) {\n          this._popup.focus();\n        }\n      }\n    });\n  };\n\n  get publicKey() {\n    return this._publicKey;\n  }\n\n  get connected() {\n    return this._publicKey !== null;\n  }\n\n  get autoApprove() {\n    return this._autoApprove;\n  }\n\n  connect = () => {\n    if (this._popup) {\n      this._popup.close();\n    }\n    return this._handleConnect();\n  };\n\n  disconnect = async () => {\n    if (this._injectedProvider) {\n      await this._sendRequest('disconnect', {});\n    }\n    if (this._popup) {\n      this._popup.close();\n    }\n    this._handleDisconnect();\n  };\n\n  sign = async (data, display) => {\n    if (!(data instanceof Uint8Array)) {\n      throw new Error('Data must be an instance of Uint8Array');\n    }\n\n    const response = await this._sendRequest('sign', {\n      data,\n      display,\n    });\n    const signature = bs58.decode(response.signature);\n    const publicKey = new PublicKey(response.publicKey);\n    return {\n      signature,\n      publicKey,\n    };\n  };\n\n  signTransaction = async (transaction) => {\n    const response = await this._sendRequest('signTransaction', {\n      message: bs58.encode(transaction.serializeMessage()),\n    });\n    const signature = bs58.decode(response.signature);\n    const publicKey = new PublicKey(response.publicKey);\n    transaction.addSignature(publicKey, signature);\n    return transaction;\n  };\n\n  signAllTransactions = async (transactions) => {\n    const response = await this._sendRequest('signAllTransactions', {\n      messages: transactions.map((tx) => bs58.encode(tx.serializeMessage())),\n    });\n    const signatures = response.signatures.map((s) => bs58.decode(s));\n    const publicKey = new PublicKey(response.publicKey);\n    transactions = transactions.map((tx, idx) => {\n      tx.addSignature(publicKey, signatures[idx]);\n      return tx;\n    });\n    return transactions;\n  };\n}\n\nfunction isString(a) {\n  return typeof a === 'string';\n}\n\nfunction isInjectedProvider(a) {\n  return isObject(a) && isFunction(a.postMessage);\n}\n\nfunction isObject(a) {\n  return typeof a === 'object' && a !== null;\n}\n\nfunction isFunction(a) {\n  return typeof a === 'function';\n}\n"],"names":["Wallet","provider","network","_handleMessage","e","_injectedProvider","source","window","origin","_providerUrl","_popup","data","method","newPublicKey","PublicKey","params","publicKey","_publicKey","equals","_handleDisconnect","_autoApprove","autoApprove","emit","result","error","_responsePromises","has","id","get","resolve","reject","Error","_handleConnect","_handlerAdded","addEventListener","disconnect","Promise","_sendRequest","name","open","toString","once","removeEventListener","forEach","connected","requestId","_nextRequestId","set","postMessage","jsonrpc","_network","focus","connect","close","sign","display","Uint8Array","response","signature","bs58","decode","signTransaction","transaction","message","encode","serializeMessage","addSignature","signAllTransactions","transactions","messages","map","tx","signatures","s","idx","isInjectedProvider","isString","URL","hash","URLSearchParams","location","Map","EventEmitter","a","isObject","isFunction"],"mappings":"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"}