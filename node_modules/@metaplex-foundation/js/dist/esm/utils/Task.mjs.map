{"version":3,"file":"Task.mjs","sources":["../../../src/utils/Task.ts"],"sourcesContent":["import AbortController from 'abort-controller';\nimport type { AbortSignal } from 'abort-controller';\nimport EventEmitterPackage from 'eventemitter3';\nimport type EventEmitter from 'eventemitter3';\nimport { TaskIsAlreadyRunningError } from '@/errors';\nimport { Disposable, DisposableScope } from './Disposable';\n\nexport type TaskStatus =\n  | 'pending'\n  | 'running'\n  | 'successful'\n  | 'failed'\n  | 'canceled';\n\nexport type TaskCallback<T, I extends any[]> = (\n  scope: DisposableScope,\n  ...inputs: I\n) => T | Promise<T>;\n\nexport type TaskOptions = {\n  signal?: AbortSignal;\n  force?: boolean;\n};\n\nexport class Task<T, I extends any[] = []> {\n  protected callback: TaskCallback<T, I>;\n  protected children: Task<any, any[]>[];\n  protected context: object;\n  protected status: TaskStatus = 'pending';\n  protected result: T | undefined = undefined;\n  protected error: unknown = undefined;\n  protected eventEmitter: EventEmitter;\n\n  constructor(\n    callback: TaskCallback<T, I>,\n    children: Task<any, any[]>[] = [],\n    context: object = {}\n  ) {\n    this.callback = callback;\n    this.children = children;\n    this.context = context;\n    this.eventEmitter = new EventEmitterPackage.EventEmitter();\n  }\n\n  async run(options: TaskOptions = {}, ...inputs: I): Promise<T> {\n    if (this.isRunning()) {\n      throw new TaskIsAlreadyRunningError();\n    }\n\n    if (this.isPending() || (options.force ?? false)) {\n      return this.forceRun(options, ...inputs);\n    }\n\n    if (this.isSuccessful()) {\n      return this.getResult() as T;\n    }\n\n    throw this.getError();\n  }\n\n  protected async forceRun(\n    options: TaskOptions = {},\n    ...inputs: I\n  ): Promise<T> {\n    const disposable = new Disposable(\n      options.signal ?? new AbortController().signal\n    );\n\n    disposable.onCancel((cancelError) => {\n      this.setStatus('canceled');\n      this.error = cancelError;\n    });\n\n    return disposable.run(async (scope: DisposableScope) => {\n      const { isCanceled, throwIfCanceled } = scope;\n\n      try {\n        // Start loading.\n        this.setStatus('running');\n        this.result = undefined;\n        this.error = undefined;\n        this.result = await Promise.resolve(this.callback(scope, ...inputs));\n        throwIfCanceled();\n        this.setStatus('successful');\n\n        // Return the loaded result.\n        return this.result;\n      } catch (newError) {\n        // Capture the error and reset the result.\n        this.error = newError;\n        this.result = undefined;\n        this.setStatus(isCanceled() ? 'canceled' : 'failed');\n\n        // Re-throw the error.\n        throw this.error;\n      }\n    });\n  }\n\n  loadWith(preloadedResult: T) {\n    this.setStatus('successful');\n    this.result = preloadedResult;\n    this.error = undefined;\n\n    return this;\n  }\n\n  reset() {\n    this.setStatus('pending');\n    this.result = undefined;\n    this.error = undefined;\n\n    return this;\n  }\n\n  setChildren(children: Task<any, any[]>[]) {\n    this.children = children;\n\n    return this;\n  }\n\n  getChildren(): Task<any, any[]>[] {\n    return this.children;\n  }\n\n  getDescendants(): Task<any, any[]>[] {\n    return this.children.flatMap((child) => [child, ...child.getDescendants()]);\n  }\n\n  setContext(context: object) {\n    this.context = context;\n\n    return this;\n  }\n\n  getContext<C extends object = object>(): C {\n    return this.context as C;\n  }\n\n  getStatus(): TaskStatus {\n    return this.status;\n  }\n\n  getResult(): T | undefined {\n    return this.result;\n  }\n\n  getError(): unknown {\n    return this.error;\n  }\n\n  isPending(): boolean {\n    return this.status === 'pending';\n  }\n\n  isRunning(): boolean {\n    return this.status === 'running';\n  }\n\n  isCompleted(): boolean {\n    return this.status !== 'pending' && this.status !== 'running';\n  }\n\n  isSuccessful(): boolean {\n    return this.status === 'successful';\n  }\n\n  isFailed(): boolean {\n    return this.status === 'failed';\n  }\n\n  isCanceled(): boolean {\n    return this.status === 'canceled';\n  }\n\n  onStatusChange(callback: (status: TaskStatus) => unknown) {\n    this.eventEmitter.on('statusChange', callback);\n\n    return this;\n  }\n\n  onStatusChangeTo(status: TaskStatus, callback: () => unknown) {\n    return this.onStatusChange((newStatus) =>\n      status === newStatus ? callback() : undefined\n    );\n  }\n\n  onSuccess(callback: () => unknown) {\n    return this.onStatusChangeTo('successful', callback);\n  }\n\n  onFailure(callback: () => unknown) {\n    return this.onStatusChangeTo('failed', callback);\n  }\n\n  onCancel(callback: () => unknown) {\n    return this.onStatusChangeTo('canceled', callback);\n  }\n\n  protected setStatus(newStatus: TaskStatus) {\n    if (this.status === newStatus) return;\n    this.status = newStatus;\n    this.eventEmitter.emit('statusChange', newStatus);\n  }\n}\n"],"names":["Task","constructor","callback","children","context","undefined","eventEmitter","EventEmitterPackage","EventEmitter","run","options","inputs","isRunning","TaskIsAlreadyRunningError","isPending","force","forceRun","isSuccessful","getResult","getError","disposable","Disposable","signal","AbortController","onCancel","cancelError","setStatus","error","scope","isCanceled","throwIfCanceled","result","Promise","resolve","newError","loadWith","preloadedResult","reset","setChildren","getChildren","getDescendants","flatMap","child","setContext","getContext","getStatus","status","isCompleted","isFailed","onStatusChange","on","onStatusChangeTo","newStatus","onSuccess","onFailure","emit"],"mappings":"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"}