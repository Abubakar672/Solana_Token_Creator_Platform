{"version":3,"file":"Disposable.mjs","sources":["../../../src/utils/Disposable.ts"],"sourcesContent":["import { AbortSignal } from 'abort-controller';\nimport EventEmitterPackage from 'eventemitter3';\nimport type EventEmitter from 'eventemitter3';\n\nexport type DisposableScope = {\n  signal: AbortSignal | undefined;\n  isCanceled: () => boolean;\n  getCancelationError: () => unknown;\n  throwIfCanceled: () => void;\n};\n\nexport class Disposable {\n  protected eventEmitter: EventEmitter;\n  protected signal: AbortSignal;\n  protected cancelationError: unknown = null;\n  protected abortListener: (error: unknown) => void;\n\n  constructor(signal: AbortSignal) {\n    this.signal = signal;\n    this.eventEmitter = new EventEmitterPackage.EventEmitter();\n    this.abortListener = (error: unknown) => {\n      this.cancelationError = error;\n      this.eventEmitter.emit('cancel', error);\n      this.close();\n    };\n    this.signal.addEventListener('abort', this.abortListener);\n  }\n\n  async run<T>(\n    callback: (scope: DisposableScope) => T,\n    thenCloseDisposable = true\n  ) {\n    try {\n      return await Promise.resolve(callback(this.getScope()));\n    } finally {\n      if (thenCloseDisposable) {\n        this.close();\n      }\n    }\n  }\n\n  getScope(): DisposableScope {\n    return {\n      signal: this.signal,\n      isCanceled: () => this.isCanceled(),\n      getCancelationError: () => this.cancelationError,\n      throwIfCanceled: () => {\n        if (this.isCanceled()) {\n          throw this.getCancelationError();\n        }\n      },\n    };\n  }\n\n  isCanceled() {\n    return this.signal.aborted;\n  }\n\n  getCancelationError() {\n    return this.cancelationError;\n  }\n\n  onCancel(callback: (reason: unknown) => unknown): Disposable {\n    this.eventEmitter.on('cancel', callback);\n\n    return this;\n  }\n\n  close() {\n    this.signal.removeEventListener('abort', this.abortListener);\n    this.eventEmitter.removeAllListeners();\n  }\n}\n"],"names":["Disposable","constructor","signal","eventEmitter","EventEmitterPackage","EventEmitter","abortListener","error","cancelationError","emit","close","addEventListener","run","callback","thenCloseDisposable","Promise","resolve","getScope","isCanceled","getCancelationError","throwIfCanceled","aborted","onCancel","on","removeEventListener","removeAllListeners"],"mappings":";;;AAWO,MAAMA,UAAN,CAAiB;EAMtBC,WAAW,CAACC,MAAD,EAAsB;AAAA,IAAA,eAAA,CAAA,IAAA,EAAA,kBAAA,EAHK,IAGL,CAAA,CAAA;;IAC/B,IAAKA,CAAAA,MAAL,GAAcA,MAAd,CAAA;AACA,IAAA,IAAA,CAAKC,YAAL,GAAoB,IAAIC,mBAAmB,CAACC,YAAxB,EAApB,CAAA;;IACA,IAAKC,CAAAA,aAAL,GAAsBC,KAAD,IAAoB;MACvC,IAAKC,CAAAA,gBAAL,GAAwBD,KAAxB,CAAA;AACA,MAAA,IAAA,CAAKJ,YAAL,CAAkBM,IAAlB,CAAuB,QAAvB,EAAiCF,KAAjC,CAAA,CAAA;AACA,MAAA,IAAA,CAAKG,KAAL,EAAA,CAAA;KAHF,CAAA;;AAKA,IAAA,IAAA,CAAKR,MAAL,CAAYS,gBAAZ,CAA6B,OAA7B,EAAsC,KAAKL,aAA3C,CAAA,CAAA;AACD,GAAA;;AAEQ,EAAA,MAAHM,GAAG,CACPC,QADO,EAEPC,mBAAmB,GAAG,IAFf,EAGP;IACA,IAAI;MACF,OAAO,MAAMC,OAAO,CAACC,OAAR,CAAgBH,QAAQ,CAAC,IAAKI,CAAAA,QAAL,EAAD,CAAxB,CAAb,CAAA;AACD,KAFD,SAEU;AACR,MAAA,IAAIH,mBAAJ,EAAyB;AACvB,QAAA,IAAA,CAAKJ,KAAL,EAAA,CAAA;AACD,OAAA;AACF,KAAA;AACF,GAAA;;AAEDO,EAAAA,QAAQ,GAAoB;IAC1B,OAAO;MACLf,MAAM,EAAE,KAAKA,MADR;AAELgB,MAAAA,UAAU,EAAE,MAAM,IAAKA,CAAAA,UAAL,EAFb;MAGLC,mBAAmB,EAAE,MAAM,IAAA,CAAKX,gBAH3B;AAILY,MAAAA,eAAe,EAAE,MAAM;QACrB,IAAI,IAAA,CAAKF,UAAL,EAAJ,EAAuB;UACrB,MAAM,IAAA,CAAKC,mBAAL,EAAN,CAAA;AACD,SAAA;AACF,OAAA;KARH,CAAA;AAUD,GAAA;;AAEDD,EAAAA,UAAU,GAAG;IACX,OAAO,IAAA,CAAKhB,MAAL,CAAYmB,OAAnB,CAAA;AACD,GAAA;;AAEDF,EAAAA,mBAAmB,GAAG;AACpB,IAAA,OAAO,KAAKX,gBAAZ,CAAA;AACD,GAAA;;EAEDc,QAAQ,CAACT,QAAD,EAAqD;AAC3D,IAAA,IAAA,CAAKV,YAAL,CAAkBoB,EAAlB,CAAqB,QAArB,EAA+BV,QAA/B,CAAA,CAAA;AAEA,IAAA,OAAO,IAAP,CAAA;AACD,GAAA;;AAEDH,EAAAA,KAAK,GAAG;AACN,IAAA,IAAA,CAAKR,MAAL,CAAYsB,mBAAZ,CAAgC,OAAhC,EAAyC,KAAKlB,aAA9C,CAAA,CAAA;IACA,IAAKH,CAAAA,YAAL,CAAkBsB,kBAAlB,EAAA,CAAA;AACD,GAAA;;AA5DqB;;;;"}